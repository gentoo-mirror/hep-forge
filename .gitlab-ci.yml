image: apnpucky/gentoo-ebuild-ci

stages:
  - check
  - install

variables:
  NAME: "hep-forge"

default:
  before_script:
    - echo "[${NAME}]">> /etc/portage/repos.conf/${NAME}.conf
    - echo "location = /var/db/repos/${NAME}" >> /etc/portage/repos.conf/${NAME}.conf
    - echo "sync-type = git" >> /etc/portage/repos.conf/${NAME}.conf
    - echo "sync-uri = https://gitlab.com/APN-Pucky/gentoo-${NAME}.git" >> /etc/portage/repos.conf/${NAME}.conf
    - emaint -r ${NAME} sync

local-repoman:
  stage: check
  before_script: []
  script:
    - repoman full -d
    - repoman -vx full

repoman:
  stage: check
  script:
    - cd /var/db/repos/${NAME}
    - repoman -vdx full

local-pkgcheck:
  stage: check
  before_script: []
  script:
    - pkgcheck scan --exit 
    
pkgcheck:
  stage: check
  script:
    - pkgcheck ci -r ${NAME} --exit 

test:
  image: apnpucky/gentoo-hep-forge
  stage: install
  parallel:
    matrix:
      - NAME: [resummino]
        VERSION: [3.1.0, 3.1.1]
  script:
    - echo $NAME-$VERSION


resummino:
  image: apnpucky/gentoo-hep-forge
  stage: install
  parallel:
    matrix:
      - NAME: [resummino]
        VERSION: [3.1.1, 3.1.0, 3.0.0]
  script:
    - emerge -qv =$NAME-$VERSION
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
      - sci-physics/$NAME/$NAME-$VERSION.ebuild